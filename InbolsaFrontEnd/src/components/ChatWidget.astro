---
/**
 * ChatWidget.astro - Chat moderno simplificado
 * Directo a WhatsApp sin selección de ciudad
 */
export const prerender = true;

const WHATSAPP = {
  number: '59169999030', // ← CAMBIA A TU NÚMERO DE WHATSAPP
  message: 'Hola Inbolsa, me gustaría recibir asesoría sobre sus soluciones.'
};

const INFO_EMPRESA = {
  vision: 'Inspirar la industria del embalaje técnico en Latinoamérica elevando el listón en ingeniería textil y servicio.',
  mision: 'Diseñamos y producimos embalajes de polipropileno con dedicación, eficiencia y soporte cercano para crear relaciones de largo plazo con cada cliente.',
  contacto: 'Atendemos desde La Paz y Santa Cruz de lunes a viernes, 09:00‑18:00. Coordinamos reuniones virtuales o visitas técnicas bajo agenda.',
  whyInbolsa: 'Con más de 50 años de experiencia, tres plantas de producción, certificación OEA y laboratorio propio, garantizamos calidad consistente, respuesta rápida y soporte técnico en cada proyecto. Acompañamos desde el diseño hasta la entrega.'
};

const SOLUCIONES_DETALLE = {
  sacos: `Sacos PP convencionales, premium y fondo cuadrado.
• Gramajes 70‑130 g/m² con impresión flexográfica a varios colores.
• Microperforado, laminado, fondos reforzados y costuras para líneas automáticas.`,
  bigbag: `Big Bags costurados, tubulares y sling bag para 500‑2.000 kg.
• Factores de seguridad 5:1, 6:1 y 8:1.
• Liners coex, válvulas de carga/descarga, asas configurables y trazabilidad.`,
  hilos: `Hilos y sogas mono/multifilamento en PP y PA.
• Bobinas, conos y lazos para costura y amarre.
• Versiones reforzadas para vibración y logística pesada.`,
  telas: `Telas y laminados técnicos para corte, liners y aplicaciones industriales.
• Planeamos anchos, densidades y tratamientos UV según proceso.`
};

const INDUSTRIAS_INFO = {
  agro: 'Agroindustria: sacos ventilados para granos y balanceados, big bags para fertilizantes y sling bag para exportación.',
  mineria: 'Minería y químico: big bags tubulares con liners ESD, trazabilidad y pruebas de tracción certificadas.',
  construccion: 'Construcción y retail: telas y sacos premium con impresión, fondos cuadrados para estibas estables y refuerzos a medida.'
};

const CULTURA_INFO = {
  valores: 'Tecnología, calidad, servicio cercano, integridad, sostenibilidad y respeto/trabajo en equipo.',
  experiencia: 'Más de 50 años fabricando en Bolivia, tres plantas con certificaciones y status OEA que garantizan procesos auditados.',
  promesa: 'Respondemos en menos de 24 horas hábiles, desarrollamos prototipos y acompañamos la homologación en planta.'
};

const SERVICIO_INFO = {
  recomendacion: 'Para recomendarte el empaque ideal necesito conocer: tipo de producto, peso aproximado por unidad, condiciones de transporte/almacenaje y si requieres impresión o normativas especiales. Con esos datos preparamos muestras o prototipos.',
  pedido: 'Podemos cotizar desde lotes estándar hasta programas just-in-time. Enviamos ficha técnica, cronograma y, si lo necesitas, coordinamos visitas a planta para cerrar detalles de costura, impresiones y logística.',
  tiemposEntrega: 'Los tiempos de entrega varían según el producto: sacos estándar (2-3 semanas), big bags personalizados (3-4 semanas), y desarrollos especiales (4-6 semanas). Ofrecemos programas de stock de seguridad para entregas recurrentes.',
  cotizacion: 'Para cotizar necesitamos: especificaciones del producto, cantidad estimada, frecuencia de pedidos y ubicación de entrega. Respondemos cotizaciones en menos de 24 horas hábiles con ficha técnica incluida.'
};

const OPERACION_INFO = {
  logistica: 'Despachamos desde La Paz y Warnes, coordinamos entregas programadas, stock de seguridad y soporte en homologaciones o pruebas internas. También manejamos documentación OEA y seguimiento de lotes.',
  certificaciones: 'Somos Operador Económico Autorizado, contamos con laboratorio propio, control por lote y procesos auditados para agro, químico y minería.',
  historia: 'Fabricamos desde 1974. En 2016 obtuvimos OEA y en 2024 ampliamos planta en Warnes para big bags y telas técnicas.'
};
---

<style>
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(20px) scale(0.95);
    }
    to {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes bubbleIn {
    0% {
      opacity: 0;
      transform: translateY(10px) scale(0.9);
    }
    50% {
      transform: translateY(-2px) scale(1.02);
    }
    100% {
      opacity: 1;
      transform: translateY(0) scale(1);
    }
  }

  @keyframes float {
    0%, 100% {
      transform: translateY(0px);
    }
    50% {
      transform: translateY(-5px);
    }
  }

.chat-panel-hidden {
  display: none;
}

  .chat-panel-visible {
    display: block;
    animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .chat-bubble-appear {
    animation: bubbleIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

.chat-fab-float {
  animation: float 3s ease-in-out infinite;
}

  #chat-messages::-webkit-scrollbar,
  #chat-quick-actions::-webkit-scrollbar {
    width: 5px;
  }

  #chat-messages::-webkit-scrollbar-track,
  #chat-quick-actions::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.05);
    border-radius: 10px;
  }

  #chat-messages::-webkit-scrollbar-thumb,
  #chat-quick-actions::-webkit-scrollbar-thumb {
    background: linear-gradient(180deg, #3E7DD2, #2563eb);
    border-radius: 10px;
  }

  #chat-messages::-webkit-scrollbar-thumb:hover,
  #chat-quick-actions::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(180deg, #2563eb, #1d4ed8);
  }

  .btn-hover-lift {
    transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  .btn-hover-lift:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(62, 125, 210, 0.3);
  }

  .btn-hover-lift:active {
    transform: translateY(0);
  }
</style>

<!-- Botón de chat anclado como floating action principal -->
  <div
    id="chat-widget-root"
    class="fixed bottom-6 right-6 md:bottom-10 md:right-10 z-[9998] pointer-events-none flex flex-col items-end gap-3"
  >
    <!-- Panel del chat -->
    <div
      id="chat-panel"
      class="chat-panel-hidden pointer-events-auto mb-3 w-[min(90vw,340px)] rounded-3xl overflow-hidden shadow-xl bg-white"
      role="dialog"
      aria-labelledby="chat-title"
      aria-hidden="true"
      style="box-shadow: 0 20px 45px -18px rgba(62, 125, 210, 0.35);"
  >
    <!-- Header con logo de Inbolsa -->
    <div class="bg-brand-600 px-4 py-3 text-white">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <div class="flex h-10 w-10 items-center justify-center rounded-xl bg-white/95 shadow-sm shadow-brand-500/30">
            <img
              src="/logo3.png"
              alt="Inbolsa"
              class="h-7 w-7 object-contain"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
            />
            <span style="display: none;" class="font-semibold text-brand-600 text-base">IB</span>
          </div>
          <div>
            <h3 id="chat-title" class="font-semibold text-white text-sm leading-tight">
              Inbolsa
            </h3>
            <p class="text-[11px] text-white/80 flex items-center gap-1 mt-0.5">
              <span class="inline-block h-2 w-2 rounded-full bg-emerald-400 animate-pulse"></span>
              <span>Asistente en línea</span>
            </p>
          </div>
        </div>
        <button
          id="chat-close"
          class="rounded-lg p-2 hover:bg-white/15 transition-all duration-200"
          aria-label="Cerrar chat"
        >
          <svg class="h-4 w-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.25" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Área de mensajes con fondo sólido y altura fija -->
    <div
      id="chat-messages"
      class="h-[340px] overflow-y-auto bg-slate-50 p-3 space-y-2"
      style="scroll-behavior: smooth;"
    >
      <!-- Los mensajes se agregarán aquí -->
    </div>

    <!-- Área de acciones con fondo blanco sólido y altura máxima con scroll -->
    <div id="chat-quick-actions" class="bg-white border-t border-slate-200 p-3 space-y-2 max-h-[200px] overflow-y-auto" style="scroll-behavior: smooth;">
      <!-- Los botones se agregarán aquí -->
    </div>
  </div>

  <!-- Botón flotante -->
  <button
    id="chat-fab"
    class="pointer-events-auto chat-fab-float relative h-14 w-14 rounded-full bg-gradient-to-br from-[#25D366] to-[#128C7E] text-white shadow-xl hover:shadow-emerald-500/50 transition-all duration-500 group"
    aria-label="Abrir chat"
    style="box-shadow: 0 24px 48px -18px rgba(18, 140, 126, 0.45);"
  >
    <div class="absolute inset-0 rounded-full bg-[#25D366] opacity-0 group-hover:opacity-20 blur-xl transition-opacity duration-500"></div>
    
    <span class="absolute inset-0 flex items-center justify-center">
      <svg class="h-7 w-7 group-hover:scale-110 transition-transform duration-300" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
      </svg>
    </span>
    
    <span 
      id="chat-badge" 
      style="display: none;" 
      class="absolute -top-1 -right-1 h-5 w-5 rounded-full bg-gradient-to-br from-red-500 to-red-600 text-white text-xs font-bold flex items-center justify-center shadow-lg animate-bounce"
    >
      1
    </span>
  </button>
</div>

<script type="module" define:vars={{ WHATSAPP, INFO_EMPRESA, SOLUCIONES_DETALLE, INDUSTRIAS_INFO, CULTURA_INFO, SERVICIO_INFO, OPERACION_INFO }}>
  let isOpen = false;
  let conversationState = 'initial';
  
  const fab = document.getElementById('chat-fab');
  const panel = document.getElementById('chat-panel');
  const closeBtn = document.getElementById('chat-close');
  const messagesContainer = document.getElementById('chat-messages');
  const quickActions = document.getElementById('chat-quick-actions');
  const badge = document.getElementById('chat-badge');

  function getSaludo() {
    const hora = new Date().getHours();
    if (hora >= 5 && hora < 12) return '¡Buenos días!';
    if (hora >= 12 && hora < 19) return '¡Buenas tardes!';
    return '¡Buenas noches!';
  }

  function addMessage(text, isBot = true) {
    const bubble = document.createElement('div');
    bubble.className = `chat-bubble-appear ${isBot ? 'flex' : 'flex justify-end'}`;

    const bgClass = isBot
      ? 'bg-white text-slate-800 shadow-sm border border-slate-200'
      : 'bg-gradient-to-br from-brand-600 to-brand-700 text-white shadow-md shadow-brand-500/20';

    const iconBot = `<svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"/>
    </svg>`;

    const iconUser = `<svg class="h-3.5 w-3.5" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
    </svg>`;

    // Formatear texto con saltos de línea
    const formattedText = text.replace(/\n/g, '<br>');

    bubble.innerHTML = `
      <div class="${bgClass} max-w-[85%] rounded-2xl px-3 py-2.5">
        <div class="text-[10px] ${isBot ? 'text-slate-500' : 'text-white/80'} mb-1 font-medium flex items-center gap-1.5">
          ${isBot ? iconBot : iconUser}
          <span>${isBot ? 'Asistente Inbolsa' : 'Tú'}</span>
        </div>
        <div class="text-[13px] leading-relaxed">${formattedText}</div>
      </div>
    `;

    messagesContainer.appendChild(bubble);

    // Scroll suave al final
    setTimeout(() => {
      messagesContainer.scrollTo({
        top: messagesContainer.scrollHeight,
        behavior: 'smooth'
      });
    }, 100);
  }

  function clearQuickActions() {
    quickActions.innerHTML = '';
  }

  function addQuickAction(label, onClick, variant = 'default', icon = '') {
    const button = document.createElement('button');

    if (variant === 'primary') {
      button.className = 'btn-hover-lift w-full rounded-xl bg-gradient-to-r from-brand-600 to-brand-700 text-white px-3 py-2 hover:from-brand-700 hover:to-brand-600 transition-all text-xs font-semibold shadow-md shadow-brand-500/25';
    } else if (variant === 'whatsapp') {
      button.className = 'btn-hover-lift w-full rounded-xl bg-gradient-to-r from-[#25D366] to-[#128C7E] text-white px-3 py-2 hover:from-[#1EBE5D] hover:to-[#0F6F5C] transition-all text-xs font-semibold shadow-md shadow-emerald-500/30';
    } else {
      button.className = 'btn-hover-lift w-full rounded-xl border border-slate-200 bg-white px-3 py-2 hover:border-brand-300 hover:bg-brand-50/50 transition-all text-xs text-left font-medium text-slate-700 hover:text-brand-700';
    }

    button.innerHTML = icon ? `<span class="flex items-center gap-2">${icon} <span>${label}</span></span>` : label;
    button.addEventListener('click', onClick);
    quickActions.appendChild(button);
  }

  function openWhatsApp() {
    const url = `https://wa.me/${WHATSAPP.number}?text=${encodeURIComponent(WHATSAPP.message)}`;
    window.open(url, '_blank', 'noopener,noreferrer');
    
    addMessage('¡Perfecto! Abriendo WhatsApp para conectarte con nuestro equipo de ventas...', true);
    setTimeout(() => {
      addMessage('¿Hay algo más en lo que pueda ayudarte?', true);
      showInitialOptions();
    }, 2000);
  }

  const icons = {
    info: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>',
    agent: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/></svg>',
    box: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>',
    building: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>',
    phone: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/></svg>',
    back: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>',
    industries: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v7H4zM6 11h12v9H6zM9 11V4m6 7V4"/></svg>',
    catalog: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h10m-10 4h6"/></svg>',
    quality: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8l-3 9 3-3 3 3-3-9zM5 4h14l-1 16H6L5 4z"/></svg>',
    custom: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L4 21l2-6.5L2 9l6.75-.5L12 2l3.25 6.5L22 9l-4 5.5 2 6.5-5.75-4z"/></svg>',
    logistics: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 15h13l3 4H6l-3-4zM3 5h13v10H3zM16 7h5v8h-5z"/></svg>',
    timeline: '<svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v14m0-14L9 8m3-3l3 3m0 11L9 16m6 3l3-3M4 7h4m-4 5h4m-4 5h4"/></svg>',
    whatsapp: '<svg class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2a9.93 9.93 0 00-9.92 10c0 1.77.47 3.5 1.36 5.02L2 22l5.11-1.31A9.93 9.93 0 0012 22a9.93 9.93 0 009.92-10A9.93 9.93 0 0012 2zm5.49 14.52c-.23.65-1.36 1.24-1.9 1.32-.49.07-1.11.1-1.79-.11-.41-.13-.94-.3-1.63-.6-2.86-1.23-4.72-4.09-4.87-4.28-.14-.19-1.16-1.54-1.16-2.94 0-1.41.74-2.1 1-2.24z"/></svg>'
  };

  function addWhatsappAction() {
    addQuickAction('Hablar con asesor de ventas', () => {
      addMessage('Hablar con asesor de ventas', false);
      openWhatsApp();
    }, 'whatsapp', icons.whatsapp);
  }

  function showInitialOptions() {
    conversationState = 'initial';
    clearQuickActions();

    addQuickAction('Explorar soluciones', () => {
      addMessage('Explorar soluciones', false);
      addMessage('Contamos con sacos PP, Big Bags, telas técnicas y líneas de hilos. Te dejo opciones específicas para que revises cada línea.', true);
      showProductosOptions();
    }, 'primary', icons.catalog);

    addQuickAction('Industrias y casos', () => {
      addMessage('Industrias y casos', false);
      addMessage('Apoyamos agroindustria, minería, químico, construcción y retail. Explora ejemplos para ver qué configuraciones usamos en cada sector.', true);
      showSolucionesOptions();
    }, 'default', icons.industries);

    addQuickAction('Valores y cultura', () => {
      addMessage('Valores y cultura', false);
      addMessage('Te cuento sobre nuestra visión, misión, valores, certificaciones y trayectoria. Selecciona lo que quieras conocer.', true);
      showCorporateOptions();
    }, 'default', icons.quality);

    addQuickAction('¿Por qué elegir Inbolsa?', () => {
      addMessage('¿Por qué elegir Inbolsa?', false);
      addMessage(INFO_EMPRESA.whyInbolsa, true);
      setTimeout(() => {
        addMessage('¿Te gustaría conocer más sobre nuestras soluciones o hablar con un asesor?', true);
        showInitialOptions();
      }, 800);
    }, 'default', icons.quality);

    addQuickAction('Cotización y pedidos', () => {
      addMessage('Cotización y pedidos', false);
      addMessage(SERVICIO_INFO.cotizacion, true);
      setTimeout(() => {
        addMessage('También puedes consultar sobre tiempos de entrega o contactar directamente a un asesor.', true);
        showPedidosOptions();
      }, 800);
    }, 'default', icons.catalog);

    addQuickAction('Contacto y horarios', () => {
      addMessage('Contacto y horarios', false);
      addMessage(INFO_EMPRESA.contacto + '\n\nEscríbenos si deseas agendar una visita técnica o reunión virtual.', true);
      setTimeout(() => {
        addWhatsappAction();
        addQuickAction('Volver al inicio', () => {
          addMessage('Volver al inicio', false);
          showInitialOptions();
        }, 'default', icons.back);
      }, 500);
    }, 'default', icons.phone);

    addWhatsappAction();
  }

  function showPedidosOptions() {
    conversationState = 'pedidos';
    clearQuickActions();

    addQuickAction('Tiempos de entrega', () => {
      addMessage('Tiempos de entrega', false);
      addMessage(SERVICIO_INFO.tiemposEntrega, true);
      setTimeout(showPedidosOptions, 500);
    }, 'default', icons.timeline);

    addQuickAction('Cómo realizar un pedido', () => {
      addMessage('Cómo realizar un pedido', false);
      addMessage(SERVICIO_INFO.pedido, true);
      setTimeout(showPedidosOptions, 500);
    }, 'default', icons.catalog);

    addQuickAction('Solicitar cotización', () => {
      addMessage('Solicitar cotización', false);
      addMessage('Te conectamos con un asesor para preparar tu cotización personalizada con ficha técnica incluida.', true);
      setTimeout(() => {
        addWhatsappAction();
        addQuickAction('Volver al inicio', () => {
          addMessage('Volver al inicio', false);
          showInitialOptions();
        }, 'default', icons.back);
      }, 500);
    }, 'default', icons.phone);

    addQuickAction('Volver al inicio', () => {
      addMessage('Volver al inicio', false);
      showInitialOptions();
    }, 'default', icons.back);

    addWhatsappAction();
  }

  function showProductosOptions() {
    conversationState = 'products';
    clearQuickActions();

    addQuickAction('Sacos PP a medida', () => {
      addMessage('Sacos PP a medida', false);
      addMessage(SOLUCIONES_DETALLE.sacos, true);
      setTimeout(() => {
        addMessage('¿Te gustaría conocer otro producto o necesitas asesoría personalizada?', true);
        showProductosOptions();
      }, 600);
    }, 'default', icons.box);

    addQuickAction('Big Bags y Sling', () => {
      addMessage('Big Bags y Sling', false);
      addMessage(SOLUCIONES_DETALLE.bigbag, true);
      setTimeout(() => {
        addMessage('¿Deseas explorar otras soluciones o hablar con un especialista?', true);
        showProductosOptions();
      }, 600);
    }, 'default', icons.logistics);

    addQuickAction('Hilos y sogas', () => {
      addMessage('Hilos y sogas', false);
      addMessage(SOLUCIONES_DETALLE.hilos, true);
      setTimeout(() => {
        addMessage('¿Quieres conocer más productos o contactar a un asesor?', true);
        showProductosOptions();
      }, 600);
    }, 'default', icons.custom);

    addQuickAction('Telas técnicas', () => {
      addMessage('Telas técnicas', false);
      addMessage(SOLUCIONES_DETALLE.telas, true);
      setTimeout(() => {
        addMessage('¿Necesitas información adicional o asesoría técnica?', true);
        showProductosOptions();
      }, 600);
    }, 'default', icons.timeline);

    addQuickAction('Asesoría personalizada', () => {
      addMessage('Asesoría personalizada', false);
      addMessage(SERVICIO_INFO.recomendacion, true);
      setTimeout(() => {
        addMessage('¿Te gustaría compartir los detalles con un asesor ahora?', true);
        addWhatsappAction();
        addQuickAction('Ver más productos', () => {
          addMessage('Ver más productos', false);
          showProductosOptions();
        }, 'default', icons.catalog);
        addQuickAction('Volver al inicio', () => {
          addMessage('Volver al inicio', false);
          showInitialOptions();
        }, 'default', icons.back);
      }, 700);
    }, 'default', icons.custom);

    addQuickAction('Volver al inicio', () => {
      addMessage('Volver al inicio', false);
      showInitialOptions();
    }, 'default', icons.back);
    addWhatsappAction();
  }

  function showSolucionesOptions() {
    conversationState = 'solutions';
    clearQuickActions();

    addQuickAction('Agroindustria', () => {
      addMessage('Agroindustria', false);
      addMessage(INDUSTRIAS_INFO.agro, true);
      setTimeout(() => {
        addMessage('¿Te gustaría conocer otra industria o necesitas una solución específica?', true);
        showSolucionesOptions();
      }, 600);
    }, 'default', icons.industries);

    addQuickAction('Minería y químico', () => {
      addMessage('Minería y químico', false);
      addMessage(INDUSTRIAS_INFO.mineria, true);
      setTimeout(() => {
        addMessage('¿Deseas explorar otros sectores o consultar sobre certificaciones?', true);
        showSolucionesOptions();
      }, 600);
    }, 'default', icons.logistics);

    addQuickAction('Construcción y retail', () => {
      addMessage('Construcción y retail', false);
      addMessage(INDUSTRIAS_INFO.construccion, true);
      setTimeout(() => {
        addMessage('¿Quieres ver más casos o hablar con un especialista del sector?', true);
        showSolucionesOptions();
      }, 600);
    }, 'default', icons.timeline);

    addQuickAction('Logística y entregas', () => {
      addMessage('Logística y entregas', false);
      addMessage(OPERACION_INFO.logistica, true);
      setTimeout(() => {
        addMessage('¿Necesitas información sobre tiempos de entrega o programas especiales?', true);
        showSolucionesOptions();
      }, 600);
    }, 'default', icons.logistics);

    addQuickAction('Certificaciones OEA', () => {
      addMessage('Certificaciones OEA', false);
      addMessage(OPERACION_INFO.certificaciones, true);
      setTimeout(() => {
        addMessage('¿Te gustaría conocer más sobre nuestros procesos de calidad?', true);
        showSolucionesOptions();
      }, 600);
    }, 'default', icons.quality);

    addQuickAction('Volver al inicio', () => {
      addMessage('Volver al inicio', false);
      showInitialOptions();
    }, 'default', icons.back);
    addWhatsappAction();
  }

  function showCorporateOptions() {
    conversationState = 'info-mode';
    clearQuickActions();

    addQuickAction('Visión y misión', () => {
      addMessage('Visión y misión', false);
      addMessage(`Visión: ${INFO_EMPRESA.vision}\n\nMisión: ${INFO_EMPRESA.mision}`, true);
      setTimeout(() => {
        addMessage('¿Te gustaría conocer más sobre nuestra cultura o trayectoria?', true);
        showCorporateOptions();
      }, 600);
    }, 'default', icons.building);

    addQuickAction('Valores y cultura', () => {
      addMessage('Valores y cultura', false);
      addMessage(`Nuestros valores fundamentales:\n${CULTURA_INFO.valores}\n\nNuestra experiencia:\n${CULTURA_INFO.experiencia}\n\nNuestra promesa:\n${CULTURA_INFO.promesa}`, true);
      setTimeout(() => {
        addMessage('¿Deseas conocer nuestra historia o certificaciones?', true);
        showCorporateOptions();
      }, 600);
    }, 'default', icons.quality);

    addQuickAction('Calidad y certificaciones', () => {
      addMessage('Calidad y certificaciones', false);
      addMessage(OPERACION_INFO.certificaciones, true);
      setTimeout(() => {
        addMessage('¿Quieres saber más sobre nuestros procesos o trayectoria?', true);
        showCorporateOptions();
      }, 600);
    }, 'default', icons.custom);

    addQuickAction('Nuestra historia', () => {
      addMessage('Nuestra historia', false);
      addMessage(OPERACION_INFO.historia, true);
      setTimeout(() => {
        addMessage('¿Te gustaría conocer nuestros valores o contactarnos?', true);
        showCorporateOptions();
      }, 600);
    }, 'default', icons.timeline);

    addQuickAction('Información de contacto', () => {
      addMessage('Información de contacto', false);
      addMessage(INFO_EMPRESA.contacto, true);
      setTimeout(() => {
        addMessage('¿Deseas agendar una visita o hablar con un asesor?', true);
        addWhatsappAction();
        addQuickAction('Ver más información', () => {
          addMessage('Ver más información', false);
          showCorporateOptions();
        }, 'default', icons.info);
        addQuickAction('Volver al inicio', () => {
          addMessage('Volver al inicio', false);
          showInitialOptions();
        }, 'default', icons.back);
      }, 600);
    }, 'default', icons.phone);

    addQuickAction('Volver al inicio', () => {
      addMessage('Volver al inicio', false);
      showInitialOptions();
    }, 'default', icons.back);
    addWhatsappAction();
  }

  function initChat() {
    addMessage(`${getSaludo()} Soy el asistente virtual de Inbolsa.`, true);
    setTimeout(() => {
      addMessage('Elige una opción rápida o cuéntame qué necesitas.', true);
      showInitialOptions();
    }, 600);
  }

  function toggleChat() {
    isOpen = !isOpen;
    if (isOpen) {
      panel.classList.remove('chat-panel-hidden');
      panel.classList.add('chat-panel-visible');
      panel.setAttribute('aria-hidden', 'false');
      if (badge) badge.style.display = 'none';
      
      if (messagesContainer.children.length === 0) {
        initChat();
      }
    } else {
      panel.classList.remove('chat-panel-visible');
      panel.classList.add('chat-panel-hidden');
      panel.setAttribute('aria-hidden', 'true');
    }
  }

  fab?.addEventListener('click', toggleChat);
  closeBtn?.addEventListener('click', toggleChat);
  
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && isOpen) {
      toggleChat();
    }
  });

  setTimeout(() => {
    if (!isOpen && badge) {
      badge.style.display = 'flex';
    }
  }, 5000);
</script>
